ARG DEBIAN_VERSION=bookworm

FROM debian:${DEBIAN_VERSION} AS builder

RUN --mount=id=apt-builder,type=cache,target=/var/cache/apt \
    apt-get update && apt-get install -y \
        build-essential \
        cmake \
        git \
    && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/ggerganov/llama.cpp.git /build

WORKDIR /build

ARG GIT_HASH=master

RUN git checkout ${GIT_HASH} \
    && cmake -B build -DLLAMA_BUILD_TESTS=off --install-prefix /app \
    && cmake --build build --config Release -j$(nproc) \
    && cmake --install build --config Release

FROM debian:${DEBIAN_VERSION}-slim

# libgomp1 definitely needs to be added.
RUN --mount=type=cache,target=/var/cache/apt \
    apt-get update && apt-get install -y \
        libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Ideally, we would also install the Python dependencies, but that seems to add another GB or two.

WORKDIR /app

# TODO Selectively copy the binaries we need since they're HUGE
COPY --from=builder /app/ .
COPY --chmod=0755 llama.sh .

ENTRYPOINT ["/app/llama.sh"]
CMD ["--help"]
